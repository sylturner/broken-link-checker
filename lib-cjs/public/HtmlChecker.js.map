{"version":3,"sources":["../../lib/public/HtmlChecker.js"],"names":["HtmlChecker","SafeEventEmitter","constructor","options","UrlChecker","on","ERROR_EVENT","error","emit","QUEUE_EVENT","LINK_EVENT","result","END_EVENT","clearCache","isPaused","numActiveLinks","numQueuedLinks","pause","resume","scan","html","baseURL","robots","auth","Error","RobotDirectives","userAgent","transitive","url","document","links","HTML_EVENT","forEach","link","resolveOnComplete","Promise","resolve","__cache","resolvePromise","COMPLETE_EVENT","attrName","get","HTML_ATTR_NAME","attrs","HTML_ATTRS","href","protocol","REBASED_URL","isInternal","IS_INTERNAL","tagName","HTML_TAG_NAME","excludedKeywords","excludedSchemes","excludeExternalLinks","excludeInternalLinks","excludeLinksToSamePage","honorRobotExclusions","includedKeywords","includeLink","IS_SAME_PAGE","oneIs","NOFOLLOW","NOINDEX","is","NOIMAGEINDEX","isRobotAttr","rel","nofollow","length","filterResult","reasons","tagNames","tagGroups","tags","filterLevel","every","set","HTML_OFFSET_INDEX","HTML_INDEX","break","include","excludedReason","undefined","enqueue","exclude","JUNK_EVENT"],"mappings":"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","sourcesContent":["import * as reasons from \"../internal/reasons\";\nimport {COMPLETE_EVENT, END_EVENT, ERROR_EVENT, HTML_EVENT, JUNK_EVENT, LINK_EVENT, QUEUE_EVENT} from \"../internal/events\";\nimport {HTML_ATTR_NAME, HTML_ATTRS, HTML_INDEX, HTML_OFFSET_INDEX, HTML_TAG_NAME, IS_INTERNAL, IS_SAME_PAGE, REBASED_URL} from \"../internal/Link\";\nimport isString from \"is-string\";\nimport {map as linkTypes} from \"link-types\";\nimport matchURL from \"../internal/matchURL\";\nimport parseHTML from \"../internal/parseHTML\";\nimport parseOptions from \"../internal/parseOptions\";\nimport RobotDirectives, {NOFOLLOW, NOIMAGEINDEX, NOINDEX} from \"robot-directives\";\nimport SafeEventEmitter from \"../internal/SafeEventEmitter\";\nimport scrapeHTML from \"../internal/scrapeHTML\";\nimport transitiveAuth from \"../internal/transitiveAuth\";\nimport UrlChecker from \"./UrlChecker\";\n\n\n\nexport default class HtmlChecker extends SafeEventEmitter\n{\n\t#auth;\n\t#excludedLinks;\n\t#options;\n\t#resolvePromise;\n\t#robots;\n\t#scanning;\n\t#urlChecker;\n\n\n\n\tconstructor(options)\n\t{\n\t\tsuper();\n\t\tthis.#options = parseOptions(options);\n\t\tthis.#reset();\n\n\t\tthis.#urlChecker = new UrlChecker(this.#options)\n\t\t.on(ERROR_EVENT, error => this.emit(ERROR_EVENT, error))\n\t\t.on(QUEUE_EVENT, () => this.emit(QUEUE_EVENT))\n\t\t.on(LINK_EVENT, result => this.emit(LINK_EVENT, result))\n\t\t.on(END_EVENT, () => this.#complete());\n\t}\n\n\n\n\tclearCache()\n\t{\n\t\tthis.#urlChecker.clearCache();\n\t\treturn this;\n\t}\n\n\n\n\t#complete()\n\t{\n\t\tconst resolvePromise = this.#resolvePromise;\n\n\t\tthis.#reset();\n\n\t\tthis.emit(COMPLETE_EVENT);\n\n\t\tresolvePromise();\n\t}\n\n\n\n\t/**\n\t * Determine whether a Link should be excluded from checks, and the reason for such.\n\t * @param {Link} link\n\t * @returns {string|undefined}\n\t */\n\t#getExcludeReason(link)\n\t{\n\t\tconst attrName = link.get(HTML_ATTR_NAME);\n\t\tconst attrs = link.get(HTML_ATTRS);\n\t\tconst {href, protocol} = link.get(REBASED_URL);\n\t\tconst isInternal = link.get(IS_INTERNAL);\n\t\tconst tagName = link.get(HTML_TAG_NAME);\n\n\t\tconst\n\t\t{\n\t\t\texcludedKeywords,\n\t\t\texcludedSchemes,\n\t\t\texcludeExternalLinks,\n\t\t\texcludeInternalLinks,\n\t\t\texcludeLinksToSamePage,\n\t\t\thonorRobotExclusions,\n\t\t\tincludedKeywords,\n\t\t\tincludeLink\n\t\t} = this.#options;\n\n\t\tif (this.#isExcludedAttribute(attrName, [tagName, \"*\"]))\n\t\t{\n\t\t\treturn \"BLC_HTML\";\n\t\t}\n\t\telse if (excludeExternalLinks && isInternal===false)\n\t\t{\n\t\t\treturn \"BLC_EXTERNAL\";\n\t\t}\n\t\telse if (excludeInternalLinks && isInternal)\n\t\t{\n\t\t\treturn \"BLC_INTERNAL\";\n\t\t}\n\t\telse if (excludeLinksToSamePage && link.get(IS_SAME_PAGE))\n\t\t{\n\t\t\treturn \"BLC_SAMEPAGE\";\n\t\t}\n\t\telse if (protocol in excludedSchemes)\n\t\t{\n\t\t\treturn \"BLC_SCHEME\";\n\t\t}\n\t\telse if (honorRobotExclusions && this.#robots.oneIs([ NOFOLLOW, NOINDEX ]))\n\t\t{\n\t\t\treturn \"BLC_ROBOTS\";\n\t\t}\n\t\telse if (honorRobotExclusions && this.#robots.is(NOIMAGEINDEX) && isRobotAttr(tagName, attrName))\n\t\t{\n\t\t\treturn \"BLC_ROBOTS\";\n\t\t}\n\t\telse if (honorRobotExclusions && attrs?.rel!=null && linkTypes(attrs.rel).nofollow)\n\t\t{\n\t\t\treturn \"BLC_ROBOTS\";\n\t\t}\n\t\telse if (matchURL(href, excludedKeywords))\n\t\t{\n\t\t\treturn \"BLC_KEYWORD\";\n\t\t}\n\t\telse if (includedKeywords.length>0 && !matchURL(href, includedKeywords))\n\t\t{\n\t\t\treturn \"BLC_KEYWORD\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\tconst filterResult = includeLink(link);\n\n\t\t\t// Undocumented support for strings (from `SiteChecker`)\n\t\t\tif (isString(filterResult) && filterResult in reasons)\n\t\t\t{\n\t\t\t\treturn filterResult;\n\t\t\t}\n\t\t\telse if (!filterResult)\n\t\t\t{\n\t\t\t\treturn \"BLC_CUSTOM\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t// Not excluded\n\t\t\t}\n\t\t}\n\t}\n\n\n\n\t/**\n\t * Determine whether a Link's HTML element and attribute would cause it to be excluded from checks.\n\t * @param {string} attrName\n\t * @param {Array<string>} tagNames\n\t * @returns {boolean}\n\t */\n\t#isExcludedAttribute(attrName, tagNames)\n\t{\n\t\tconst tagGroups = this.#options.tags[this.#options.filterLevel];\n\n\t\treturn tagNames.every(tagName => !(tagName in tagGroups) || !(attrName in tagGroups[tagName]));\n\t}\n\n\n\n\tget isPaused()\n\t{\n\t\treturn this.#urlChecker.isPaused;\n\t}\n\n\n\n\t/**\n\t * Enqueue a Link if it is valid and passes filters.\n\t * @param {Link} link\n\t */\n\t#maybeEnqueueLink(link)\n\t{\n\t\tif (link.get(REBASED_URL) === null)\n\t\t{\n\t\t\tlink.set(HTML_OFFSET_INDEX, link.get(HTML_INDEX) - this.#excludedLinks);\n\t\t\tlink.break(\"BLC_INVALID\");\n\t\t\tlink.include();\n\n\t\t\tthis.emit(LINK_EVENT, link);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tconst excludedReason = this.#getExcludeReason(link);\n\n\t\t\tif (excludedReason === undefined)\n\t\t\t{\n\t\t\t\tlink.set(HTML_OFFSET_INDEX, link.get(HTML_INDEX) - this.#excludedLinks);\n\t\t\t\tlink.include();\n\n\t\t\t\tthis.#urlChecker.enqueue(link, null, this.#auth);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tlink.set(HTML_OFFSET_INDEX, this.#excludedLinks++);\n\t\t\t\tlink.exclude(excludedReason);\n\n\t\t\t\tthis.emit(JUNK_EVENT, link);\n\t\t\t}\n\t\t}\n\t}\n\n\n\n\tget numActiveLinks()\n\t{\n\t\treturn this.#urlChecker.numActiveLinks;\n\t}\n\n\n\n\tget numQueuedLinks()\n\t{\n\t\treturn this.#urlChecker.numQueuedLinks;\n\t}\n\n\n\n\tpause()\n\t{\n\t\tthis.#urlChecker.pause();\n\t\treturn this;\n\t}\n\n\n\n\t#reset()\n\t{\n\t\tthis.#auth = null;\n\t\tthis.#excludedLinks = 0;\n\t\tthis.#resolvePromise = null;\n\t\tthis.#robots = null;\n\t\tthis.#scanning = false;\n\t}\n\n\n\n\tresume()\n\t{\n\t\tthis.#urlChecker.resume();\n\t\treturn this;\n\t}\n\n\n\n\t// `robots` and `auth` are undocumented and for internal use only\n\tasync scan(html, baseURL, robots, auth)\n\t{\n\t\tif (this.#scanning)\n\t\t{\n\t\t\tthrow new Error(\"Scan already in progress\");\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// Prevent user error with missing undocumented arugment\n\t\t\tif (!(robots instanceof RobotDirectives))\n\t\t\t{\n\t\t\t\trobots = new RobotDirectives({ userAgent: this.#options.userAgent });\n\t\t\t}\n\n\t\t\tconst transitive = transitiveAuth(baseURL, auth);\n\n\t\t\tbaseURL = transitive.url;  // @todo remove hash (and store somewhere?)\n\n\t\t\tthis.#auth = transitive.auth;\n\t\t\tthis.#robots = robots;\n\t\t\tthis.#scanning = true;\n\n\t\t\tconst document = await parseHTML(html);\n\t\t\tconst links = scrapeHTML(document, baseURL, this.#robots);  // @todo add auth?\n\n\t\t\tthis.emit(HTML_EVENT, document, this.#robots);\n\n\t\t\tlinks.forEach(link => this.#maybeEnqueueLink(link));\n\n\t\t\tconst resolveOnComplete = new Promise(resolve => this.#resolvePromise = resolve);\n\n\t\t\t// If no links found or all links already checked\n\t\t\tif (this.#urlChecker.numActiveLinks===0 && this.#urlChecker.numQueuedLinks===0)\n\t\t\t{\n\t\t\t\tthis.#complete();\n\t\t\t}\n\n\t\t\treturn resolveOnComplete;\n\t\t}\n\t}\n\n\n\n\tget __cache()\n\t{\n\t\treturn this.#urlChecker.__cache;\n\t}\n}\n\n\n\n//::: PRIVATE FUNCTIONS\n\n\n\nconst isRobotAttr = (tagName, attrName) =>\n{\n\treturn (tagName===\"img\"      && attrName===\"src\"   ) ||\n\t       (tagName===\"input\"    && attrName===\"src\"   ) ||\n\t       (tagName===\"menuitem\" && attrName===\"icon\"  ) ||\n\t       (tagName===\"video\"    && attrName===\"poster\");\n};\n"],"file":"HtmlChecker.js"}